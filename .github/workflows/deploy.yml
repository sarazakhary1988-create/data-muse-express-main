name: Deploy MANUS 1.6 MAX

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Validate Code Syntax
      run: |
        npm install --legacy-peer-deps
        npm run lint || true
    
    - name: Run Tests
      run: npm test || true
    
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
    
    - name: Link to Supabase
      run: |
        supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} || true
      env:
        SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
    
    - name: Push Database Migrations
      run: |
        supabase db push || true
      env:
        SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
    
    - name: Deploy Functions
      run: |
        supabase functions deploy || true
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
    
    - name: Health Check
      run: |
        echo "Checking system health..."
        curl -s https://${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co/functions/v1/llm-router/health || echo "Health check endpoint not yet deployed"
      continue-on-error: true
